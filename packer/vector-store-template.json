{
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "{{user `aws_region`}}",
      "ami_name": "{{ user `vector_image_name` }}",
      "source_ami": "{{ user (printf \"aws_source_ami_%s\" (user \"arch\")) }}",
      "instance_type": "{{user (printf \"aws_instance_type_%s\" (user \"arch\")) }}",
      "ami_regions": "{{user `aws_regions`}}",
      "user_data_file": "files/user_data.txt",
      "subnet_filter": {
        "filters": {
          "tag:Name": "image-build-subnet*"
        },
        "most_free": true,
        "random": false
      },
      "associate_public_ip_address": "true",
      "ssh_username": "{{user `aws_ssh_username`}}",
      "ssh_timeout": "5m",
      "ena_support": true,
      "shutdown_behavior": "terminate",
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_type": "gp3",
          "volume_size": 30,
          "delete_on_termination": true
        }
      ],
      "ami_org_arns": [
        "arn:aws:organizations::978072043225:organization/o-o561yy1rs6"
      ],
      "snapshot_users": [
        "797456418907",
        "734708892259"
      ],
      "tags": {
        "Name": "{{ user `vector_image_name` }}",
        "vector-store-version": "{{ user `vector_version`| clean_resource_name }}",
        "arch": "{{ user `arch` }}"
      },
      "run_tags": {
        "Name": "packer-build-{{ user `vector_image_name` }}-builder",
        "Owner": "vector-build",
        "RunByUser": "vector-build",
        "arch": "{{ user `arch` }}"
      },
      "run_volume_tags": {
        "Name": "packer-build-{{ user `vector_image_name` }}-volume",
        "Owner": "vector-build",
        "RunByUser": "vector-build",
        "arch": "{{ user `arch` }}"
      }
    },
    {
      "type": "googlecompute",
      "project_id": "{{user `gcp_project_id`}}",
      "zone": "{{user `gcp_zone`}}",
      "source_image_family": "{{ user (printf \"gcp_source_image_family_%s\" (user \"arch\")) }}",
      "image_storage_locations": ["{{user `gcp_image_storage_location`}}"],
      "machine_type": "{{user (printf \"gcp_instance_type_%s\" (user \"arch\")) }}",
      "ssh_username": "{{user `gcp_ssh_username`}}",
      "ssh_timeout": "6m",
      "metadata": { "block-project-ssh-keys": "TRUE" },
      "image_family": "vector-store",
      "image_name": "{{ user `vector_image_name` }}",
      "instance_name": "{{ user `vector_image_name` }}",
      "image_description": "ScyllaDB vector store service {{user `vector_version`| clean_resource_name}}",
      "use_internal_ip": false,
      "preemptible": true,
      "omit_external_ip": false,
      "disk_size": 40,
      "disk_type": "pd-balanced",
      "image_labels": {
        "vector-store-version": "{{ user `vector_version`| clean_resource_name }}",
        "arch": "{{ user `arch` }}"
      },
      "labels": {
        "keep": 1,
        "keep_action": "terminate",
        "arch": "{{ user `arch` }}"
      }
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "files/",
      "destination": "/home/ubuntu/"
    },
    {
      "type": "shell",
      "inline": [
        "sudo apt-get update --fix-missing -y",
        "sudo apt-get upgrade -y",
        "sudo apt-get install -y python3-setuptools",
        "sudo apt-get install -y python3-pip"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "sudo /home/{{user `aws_ssh_username`}}/vector_store_install_image {{ user `aws_install_args` }}"
      ],
      "only": ["amazon-ebs"]
    },
    {
      "type": "shell",
      "inline": [
        "sudo /home/{{user `gcp_ssh_username`}}/vector_store_install_image {{ user `gcp_install_args` }}"
      ],
      "only": ["googlecompute"]
    }
  ],
  "post-processors": [
    {
      "type": "manifest",
      "output": "packer-manifest.json",
      "strip_path": true
    }
  ],
  "variables": {
    "vector_version": "",
    "vector_image_name": "vector-store-{{ user `vector_version` | replace_all \".\" \"-\" }}-{{ user `arch` }}-{{ isotime \"2006-01-02t03-04-05z\" }}",

    "arch": "amd64",
    "aws_region": "us-east-1",
    "aws_regions": "us-west-2,eu-west-2,eu-west-1,eu-central-1,eu-north-1",
    "aws_source_ami_amd64": "ami-02a35bd020554f400",
    "aws_instance_type_amd64": "c4.xlarge",
    "aws_source_ami_arm64": "ami-026fccd88446aa0bf",
    "aws_instance_type_arm64": "c7g.xlarge",

    "aws_ssh_username": "ubuntu",
    "aws_install_args": "--cloud aws --verbose --version {{ user `vector_version` }} --arch {{ user `arch` }}",

    "gcp_project_id": "scylla-images",
    "gcp_zone": "europe-west1-b",
    "gcp_image_storage_location": "europe-west1",

    "gcp_source_image_family_amd64": "ubuntu-minimal-2204-lts",
    "gcp_instance_type_amd64": "n1-standard-1",

    "gcp_source_image_family_arm64": "ubuntu-minimal-2204-lts-arm64",
    "gcp_instance_type_arm64": "t2a-standard-2",
    "gcp_ssh_username": "ubuntu",
    "gcp_install_args": "--cloud gce --verbose --version {{ user `vector_version` }} --arch {{ user `arch` }}"
  }
}
